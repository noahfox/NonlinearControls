clear *; close all; clc

global best_yet initials
best_yet = 0;
consts = get_consts();

% States: x=[y,z,th,psi,dy,dz,dth,dpsi,m]'
fuel = consts.m_nofuel+consts.max.m_fuel;
initials = [10 150 0.1 0 0 0 0 0 fuel;
            50 1500 0.2 0 0 0 0 0 fuel;
            100 25 0 0 0 0 0 0 fuel;
            100 500 pi/2 0 0 0 0 0 fuel;
            10 1500 179*pi/180 0 0 0 0 0 fuel];


opts.MaxFunEvals  = 50000;
opts.TolX = 1e-6;
opts.StopFitness = 1e-6;
opts.CMA.active = 1;
opts.Restarts = 0;
opts.LogPlot = 'off';
opts.StopOnStagnation = 'on';
opts = cmaes('defaults', opts);

% sigma = [.001 .001 10 .001 .001 .001 1 .001 0.001 0.1 0.1]';
% sigma = 0.1;
ksig = [.2 .4 .03 .01 1.3 2.3 .01 .01 .01 .01 .01 12 24 .4 .01 16 10 .01];
qrsig = [ .01 .01 30 .01 .01 .01 3 .01 .01 .01 .5];
switchsig = [.01 .03 30 10];
sigma = [ksig qrsig switchsig]';
% x0 = [0.001 0.001 100 0.001 0.001 0.001 10 0.001 0.001 .5 2.0...
%       0.1 100 10 0.000001 0.001 0.001 .001 0.001 0.001 .1 10];
% x0 = [ -0.7544 1.1544 0 0 -5.5728 8.5728 0 0 -0.1575];

k = [-0.684995189331813,1.15059724593106,-0.102287336164053,0.0697255362865406,-5.61834282543692,8.46906736340270,-0.0865564201780617,-0.00516796088993788,-0.150346777975641, 0.1306    0  -37.6338   72.8933    1.6009    0  -48.6607   30.3236    0];
qr = [0.00204073753336390; -0.000908019845082666;94.6797088671666;-0.000565059278701018;-0.000481162874801398;0.00119017653895017;8.89500774975685;0.00379848720593460;-0.000741772844496262;0.529571440663460;1.85372872712185]; 
switchs = [.05 .1 100 30];
x0 = [k qr' switchs];
% x0 = [-0.817773334725316,1.42264844661332,-0.150966700605397,0.0931472512821984,-6.39116125444814,12.7411142681841,-0.0846091756820005,-0.0135195824539072,-0.149744777853143,0.144986114030858,0.00489474158082315,-28.4321973792661,85.3079411539528,1.21461743399794,-0.0173863259124559,-60.0298845197917,38.8919411926537,-0.00233255524517929];

[XMIN,FMIN,COUNTEVAL,STOPFLAG,OUT,BESTEVER] = cmaes('costfun',x0,sigma,opts);
